(function () {

    var FormChooserField = function (form_search_url) {
        return {
            type: 'chooser',
            label: 'Form Chooser',
            model: 'form',
            chooserButtonText: 'Choose Form',
            getItems: function(query, page, perPage, callback) {
                var str = 'q='+query + '&page='+page + '&perPage='+perPage
                fetch( form_search_url + '?' + str, {credentials: 'include'})
                .then(function(response) { return response.json() })
                .then(function(data) {
                    callback({
                        total: data.length,
                        currentPage: 1,
                        result: data,
                    })
                })
            },

            displayItem: function(item) {
                return '<div class="card text-center"><div class="card-body"><h5 class="card-title">'+ item.title +'</h5></div></div>'
            },

            displaySelectedItem: function (item) {
                return '<div class="card text-center"><div class="card-body"><h5 class="card-title">'+ item.title +'</h5></div></div>'
            }
        }
    }

    var PageChooserField = function (page_search_url) {
        return {
            type: 'chooser',
            label: 'Page Chooser',
            model: 'page',
            chooserButtonText: 'Choose Page',
            getItems: function(query, page, perPage, callback) {
                var str = 'q='+query + '&page='+page + '&perPage='+perPage
                fetch( page_search_url + '?' + str, {credentials: 'include'})
                .then(function(response) { return response.json() })
                .then(function(data) {
                    callback({
                        total: data.total,
                        currentPage: data.current_page,
                        result: data.result,
                        perPage:perPage
                    })
                })
            },

            displayItem: function(item) {
                return '<div class="card text-center"><div class="card-body"><h5 class="card-title">'+ item.title +'</h5></div></div>'
            },

            displaySelectedItem: function (item) {
                return '<div class="card text-center"><div class="card-body"><h5 class="card-title">'+ item.title +'</h5></div></div>'
            }
        }
    }

    var FormChooserBlock = function (formChooser, pageChooser) {
        pageChooser.model = 'successPage'
        pageChooser.label = 'Success Page'
        return {
            title: 'Form',
            description: 'Choose a Form',
            default_values: {
                settings: {
                    dropdownLevel: 0
                }
            },
            config: {
                preview: function (self, callback) {
                    callback('Form: ' + self.title)
                },
                styles: [{id: 'default', name: 'Default'}]
            },
            settings_schema: {
                fields: [
                    {
                        'type': 'input',
                        'inputType': 'text',
                        'label': 'Title',
                        'model': 'title'
                    },
                    formChooser,
                    pageChooser
                ]
            }
        }
    }


    var formChooserBlock = FormChooserBlock(FormChooserField(WAGTAIL_FORM_SEARCH_URL), PageChooserField(WAGTAIL_PAGE_SEARCH_URL))

    hyperEditor.register_block('form', formChooserBlock)
})()