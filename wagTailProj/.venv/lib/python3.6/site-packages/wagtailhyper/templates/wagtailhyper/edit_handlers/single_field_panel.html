{% load wagtailadmin_tags static %}
{% with 'hef_'|add:identifier as field_id_str %}
{% with 'hei_'|add:identifier as iframe_id_str %}
<fieldset style="margin-right:0px;width: 100%;max-width: 100%;">
    <legend>{{ self.heading }}</legend>
    <ul class="fields">
        <li id="{{ field_id_str }}", style="display:none">
            {% include "wagtailadmin/shared/field.html" with show_label=False show_help_text=False %}
        </li>
    </ul>

    <iframe name="editorIframe" src="#" frameborder="0" width="100%" marginheight="0" marginwidth="0" style="min-height:100vh" id="{{ iframe_id_str }}"></iframe>

    <script>
        (function () {
            var field_id = '{{ field_id_str }}'
            var iframe_id = '{{ iframe_id_str }}'

            function guid() {
                function s4() {
                    return Math.floor((1 + Math.random()) * 0x10000)
                    .toString(16)
                    .substring(1);
                }
                return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
            }

            // generate an unique id param
            var id = guid()

            // initialize iframe
            var iframe = document.querySelector('#'+iframe_id);
            iframe.src = '{% url 'wagtailhyper_editor_iframe' %}' + '?id=' + id

            // get iframe window object
            var iframeWindow = (iframe.contentWindow || iframe.contentDocument);

            // get hidden textarea
            var hiddenEditor = document.querySelector('#'+field_id + ' #hyperHiddenField')

            // polyfill window localtion origin
            if (!window.location.origin) {
                window.location.origin = window.location.protocol + "//"
                    + window.location.hostname
                    + (window.location.port ? ':' + window.location.port : '');
            }

            iframe.onload = function() {

                if (hiddenEditor.value && hiddenEditor.value != '') {
                    iframeWindow.postMessage({
                        id: id,
                        state: hiddenEditor.value
                    }, window.location.origin)
                } else {
                    iframeWindow.postMessage({
                        id: id,
                        state: '[]'
                    }, window.location.origin)
                }

                window.addEventListener('message',function(e) {
                    if (e.data && e.data.id == id) {
                        hiddenEditor.value = e.data.state
                    }

                },false);
            }
        })()
    </script>
</fieldset>
{% endwith %}
{% endwith %}

